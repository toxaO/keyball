# Keyball ver1.1 リリースノート

## 概要
ver1.1 では Vial のキーマップ移行手順を見直し、振動ドライバ（DRV2605L）を標準サポートするほか、スワイプ系の割り当てやユーティリティマクロを大幅に見直しました。頒布用 user キーマップを一括ビルドするスクリプトやドキュメント更新もあわせて含まれます。

## Vial キーマップ移行の注意（最重要）
- ver1.1 を書き込む前に、かならず Vial 上でキーマップをエクスポートしてください。アップデート後は `KBC_RST` → `KBC_SAVE` を一度実行し、Vial で設定を再インポートする必要があります。
- `KBC_RST` を挟まないと新しい設定領域が初期化されず、AML やハプティック関連の設定が不定になる場合があります。
- OLED で項目を調整した後は `KBC_SAVE` を押して保存してください。保存しない場合は再接続時に設定が失われます。

## 主な変更点
### AML / ハプティック
- DRV2605L（I2C 接続）による振動ドライバを正式サポートし、左右それぞれのモーターを制御できるようになりました（ver1.0 には未搭載）。
- Auto Mouse Layer（AML）入退場時に専用エフェクトを鳴らせるようになり、OLED の「AML haptic」ページからエフェクト番号／有効/無効をリアルタイムで設定できます。
- スワイプ時の一次／二次エフェクト、レイヤーごとの左右エフェクトも OLED から設定可能になりました（SW_Hp / Ly_Hp ページ）。
- 連続発火時のクールダウン値（Idle）を設定し、振動し続ける状況を防げます。

### スワイプ / マクロ
- `SW_UTIL` を追加し、Esc→LANG2 をタップで呼び出しつつ、上下左右にコピー/ペースト/Undo/Redo を割り当てました。
- `SW_VOL`（音量/再生）や `SW_WIN`（Windows Snap / mac Fn+Ctrl）など OS ごとに異なるショートカットを `tap_code16_os()` へ統一し、左右方向の挙動を調整しました。
- ブラウザスワイプではダブルタップでリロードできるようになり、`SW_EX1/EX2` や FLICK_* の方向割り当ても実装通りの値にそろえました。
- user/toxaO 双方のマクロを再整理し、HOME/END/PGUP/PGDN などの挙動を安定化しました。

### ビルド / ドキュメント
- `scripts/build_user_maps.sh` を追加し、`keyball{39,44,61}` × `user_{dual,left,right}` の 9 ターゲットを一括ビルドできるようにしました（`README.md` にも記載）。
- `README.md` のクイックスタートで user キーマップ名（`user_dual` など）を明記し、誤って `:user` を指定した際にビルドできない問題を予防しています。
- `docs/manual_setup.md` / `docs/docker_setup.md` を最新のコマンド・スクリプトに合わせて更新しました。
- GitHub Actions の手動ビルド Workflow（`build.yml`）を削除し、CI に依存しないリリースフローへ一本化しました。

## 推奨アップデート手順
1. 旧バージョン（ver1.0）で Vial 設定をエクスポートする。
2. ver1.1 の `.uf2` を書き込む（必要に応じて `scripts/build_user_maps.sh` で最新ビルドを作成）。
3. 本体で `KBC_RST` → `KBC_SAVE` を実行し、新しい設定構造を初期化する。
4. Vial を開いて設定をインポート、または手動でキーマップを調整し、完了後に再度 `KBC_SAVE` を押す。
5. AML/スワイプ/ハプティックの動作を確認し、必要なら OLED 設定画面で値を微調整する。

## 既知の注意点
- user 版のビルドターゲットは `user_dual` / `user_left` / `user_right` の 3 種です。`keyball/keyballXX:user` を指定するとビルドできないので注意してください。
- `scripts/build_user_maps.sh` は 9 ターゲットを順番にビルドするため、環境によっては 5〜6 分程度かかります。時間短縮が必要な場合は `MAKE_TARGETS` 相当の配列を編集して対象を絞ってください。
- Docker でビルドする場合はホストの `build/` をマウントした状態で `scripts/build_user_maps.sh` または `scripts/build_vial_all.sh` を実行すると、成果物をホストから直接取得できます。
