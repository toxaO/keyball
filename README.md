# Keyball（本ファーム概要）

このリポジトリは Keyball シリーズ用ファームウェア（QMKベース）です。公式実装に準拠しつつ、Vial対応やOLED上での詳細設定、スワイプ機能など拡張を含みます。各キーボードのソースは `keyball/<board>/` にあります。

対応ボード（RP2040系）
- RP2040 へ載せ替えが必要です（ATmega32U4等のままでは使用できません）。
- 推奨ボード: 下記いずれか
  - AliExpressの本品: https://ja.aliexpress.com/item/1005005980167753.html?channel=twinner
  - RP2040 ProMicro 互換（4MBで可）

このファームで利用できる主な機能
- Vial 対応（キーマップの動的編集が可能）
- OLED 上での設定調整（詳細は `/keyball/README.md`）
  - マウス（ポインタ）設定: CPI, 低速ゲイン(Glo), しきい値(Th1/Th2)
  - AML（Auto Mouse Layer）: 有効/タイムアウト/閾値/ターゲットレイヤ
  - スクロール: ステップ(ST), デッドゾーン(Dz), 反転(Inv), プリセット(Mode)
  - スクロール最終ゲイン: 水平H_Ga（垂直基準に対する%）
  - スクロールスナップ: モード(垂直/水平/自由), 閾値, リセット時間
  - スワイプとマルチキー: 閾値/デッドゾーン/リセット/フリーズの調整
  - デフォルトレイヤー設定
- スワイプ拡張（例: 疑似フリック入力）
  - スワイプ押下中に方向別動作を定義可能。ユーザーフックでアプリ/履歴/音量など自由に割り当てできます。
  - 擬似フリック入力（例: 方向に応じた文字入力・アクション）もユーザー実装で可能です。

詳細ドキュメント
- OLEDの設定項目、デフォルト搭載スワイプ・マルチキー・カスタムキーコードの一覧は `/keyball/README.md` を参照。
- APIや詳細仕様は `keyball/lib/keyball/README.md` を参照。

RP2040 への書き込み方法（重要）
- まず基板に取り付ける前に RP2040へファーム（.uf2）を書き込みます。
- RP2040ボードのリセットボタンを押しながらPCへ接続すると、PCにストレージ（RPI-RP2等）として認識されます。そこへ .uf2 ファイルをドラッグ＆ドロップします。
- 基板への取り付け方向: RP2040 ProMicro のリセットボタンが下向きで隠れるように取り付けてください。
  - 念のため、基板のシルクの文字位置が元のProMicroと一致するかを自身でも確認してください。
- 取り付け後の書き込み: Keyball側のリセット（タクトスイッチ）を素早く2回押すと、PCに書き込み可能モード（BOOTSEL）が現れます（`QK_BOOT` でも可）。

セットアップとビルド
- シェルスクリプトによる導入（MSYS2/macOS/Ubuntu想定）
  - `bash scripts/setup_and_build.sh`
  - 依存確認→qmk CLI venv→シンボリックリンク作成→QMK & Vial ビルドまで自動実行
- GitHub Actions でのビルド
  - Actions → "Keyball manual build (QMK/Vial)"
  - 入力フォームで kb（例: keyball/keyball61）, km（例: mymap）, impl（qmk/vial）を選択
- Vial 上でキーマップの編集が可能です（Vial対応ビルドを使用）。

既知の注意点 / 既知の不具合
- 初期状態で row0, col1 が原因不明のバグにより KC_R になってしまうことがあります。Vialで手動で書き換えてください。
- 旧実装と異なり、現状は「ボール側」にUSBケーブルを接続しないとポインタが動きません（QMK0.27以降の公式ドライバへの切替の影響）。方法が分かり次第、改善対応予定です。

ビルド済み生成物
- `build/` ディレクトリにビルド済みファームが入っています（必要に応じて更新）。

問い合わせ
- 公式ではなく、こちらへお願いします: https://x.com/toxa_craft

---

開発者向けメモ
- 各ボードのソースは `keyball/<board>/` にあります（例: keyball39, keyball44, keyball61）。
- 共通機能・APIは `keyball/lib/keyball/` を参照。
- キー配列・ユーザー側機能の例は `keyball/lib_user/` を参照。
